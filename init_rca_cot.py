from openai_client import get_openai_client
import json
import os

def get_root_cause_analysis(enriched_incident, metrics_data, logs_data, events_data):
    prompt = f"""
Given the following observability data for incident "{enriched_incident}":
- Metrics: {metrics_data}
- Logs: {logs_data}
- Events: {events_data}

Please provide a comprehensive root cause analysis following these steps:

1. Impact Assessment
   - Determine if this is a systemic or isolated issue
   - Quantify affected users/services
   - Evaluate business impact severity
   - Define impact duration

2. Initial Symptom Analysis
   - Document observed anomalies
   - Identify primary error patterns
   - List affected components
   - Note any correlation with recent changes

3. Data Collection & Correlation
   - Analyze error logs and stack traces
   - Review monitoring metrics
   - Examine distributed traces
   - Correlate user feedback
   - Map system dependencies

4. Timeline Construction
   - Create incident timeline
   - Mark key events and changes
   - Identify potential trigger points
   - Note any pattern emergence

5. Pattern Recognition & Analysis
   - Identify anomaly patterns
   - Analyze performance bottlenecks
   - Map dependency relationships
   - Document system behavior changes

6. Hypothesis Formation
   - List potential root causes
   - Rank by probability
   - Document supporting evidence
   - Note conflicting indicators

7. Verification Steps
   - Define reproduction steps
   - Document test scenarios
   - List verification methods
   - Specify success criteria

8. Root Cause Confirmation
   - Present confirmed root cause
   - Provide supporting evidence
   - Document verification results
   - Address any uncertainty

9. Resolution Plan
   - Define immediate fixes
   - List long-term improvements
   - Specify validation steps
   - Include rollback plan

10. Prevention Measures
    - Recommend monitoring improvements
    - Suggest process changes
    - Define success metrics
    - Outline follow-up actions

Please follow this structure and provide detailed analysis for each section based on the available data.
"""

    client = get_openai_client()

    response = client.chat.completions.create(
        model="qwen-max-2025-01-25",
        messages=[
            {'role': 'system', 'content': 'You are a helpful assistant.'},
            {'role': 'user', 'content': prompt}
        ]
    )
    root_cause_analysis = response.choices[0].message.content.strip()
    return root_cause_analysis

# Example usage
if __name__ == "__main__":
    enriched_incident = {
      "incident": {
        "title": "实时风控决策延迟分析",
        "affected_components": {
          "primary_system": "实时风控决策（风险管理）",
          "dependent_systems": [
            "大数据平台",
            "核心系统",
            "安全认证",
            "用户中心",
            "反欺诈"
          ],
          "transaction_chain": [
            "业务请求接入层",
            "规则引擎计算节点",
            "风险特征计算服务",
            "外部数据源接口",
            "决策结果反馈通道"
          ]
        },
        "severity": "High",
        "symptom_analysis": {
          "observed_issues": [
            "单笔决策耗时从50ms上升至300-800ms",
            "吞吐量下降60%但CPU使用率<30%",
            "规则执行日志无异常告警",
            "第三方特征服务延迟波动（P99从120ms升至450ms）"
          ],
          "technical_characteristics": {
            "timing": "业务高峰时段（10:00-15:00）",
            "frequency": "持续发生但存在间歇性恢复",
            "impact_scope": "影响所有风控拦截类交易",
            "system_behavior": "JVM Full GC次数正常，线程池队列积压突增"
          }
        },
        "time_range": {
          "start": "2023-08-15T10:00:00+08:00",
          "end": "2023-08-15T14:00:00+08:00",
          "duration_hours": 4
        },
        "business_impact": {
          "operational_impact": [
            "支付类交易平均延迟增加2.3秒",
            "自动阻断率异常升高0.5%",
            "人工审核工单量激增120%"
          ],
          "customer_experience": [
            "电商支付失败率上升至0.8%",
            "客户投诉量增加65件/小时",
            "高风险交易人工复核导致用户体验下降"
          ]
        },
        "recommended_actions": {
          "dependency_analysis": [
            "检查大数据平台特征计算响应时间分布",
            "验证三方反欺诈接口SLI达标率",
            "跟踪规则引擎执行计划生成耗时"
          ],
          "system_analysis": [
            "分析决策服务线程池阻塞情况",
            "检查JIT编译热点方法变更",
            "验证缓存服务连接池利用率",
            "监控数据库慢查询日志"
          ],
          "dataflow_analysis": [
            "采样全链路trace分析耗时分布",
            "检查特征数据序列化/反序列化性能",
            "验证实时事件流处理延迟"
          ],
          "external_services": [
            "核查人行公安接口响应时间",
            "测试短信平台异步通知延迟",
            "评估安全认证服务令牌获取效率"
          ],
          "log_analysis": [
            "检索规则引擎调试日志中的warning模式",
            "分析线程dump中的锁竞争情况",
            "核对时钟同步服务状态"
          ]
        }
      }
    }
    metrics_data = """
    #metric=throughput_tps,type=counter,service=risk_management,component=rule_engine
    1692069080,4768.42
    1692069090,4720.86
    1692069100,4710.26
    1692069110,4766.60
    1692069120,4777.29
    1692069130,4728.53
    1692069140,4735.16
    1692069150,4711.46
    1692069160,4732.82
    1692069170,4721.50
    1692069180,4727.29
    1692069190,4735.83
    1692069200,4703.99
    1692069210,4717.03
    1692069220,4686.50
    1692069230,4713.79
    1692069240,4717.33
    1692069250,4722.09
    1692069260,4720.62
    1692069270,4732.21
    1692069280,4681.65
    1692069290,4681.03
    1692069300,4719.65
    1692069310,4666.60
    1692069320,4709.36
    1692069330,4680.40
    1692069340,4733.77
    1692069350,4705.64
    1692069360,4694.56
    1692069370,4721.81
    1692069380,4674.30
    1692069390,4676.41
    1692069400,4666.96
    1692069410,4673.20
    1692069420,4690.03
    1692069430,4697.00
    1692069440,4704.66
    1692069450,4647.25
    1692069460,4678.62
    1692069470,4658.21
    1692069480,4674.58
    1692069490,4723.68
    1692069500,4681.14
    1692069510,4691.61
    1692069520,4711.14
    1692069530,4692.79
    1692069540,4659.60
    1692069550,4641.35
    1692069560,4664.57
    1692069570,4652.13
    1692069580,4631.31
    1692069590,4664.93
    1692069600,4663.74
    1692069610,4692.12
    1692069620,4647.81
    1692069630,4658.96
    1692069640,4638.36
    1692069650,4667.45
    1692069660,4645.80
    1692069670,4623.15
    1692069680,4644.65
    1692069690,4651.04
    1692069700,4646.65
    1692069710,4660.77
    1692069720,4609.20
    1692069730,4619.62
    1692069740,4647.58
    1692069750,4618.59
    1692069760,4636.22
    1692069770,4581.33
    1692069780,4682.35
    1692069790,4620.95
    1692069800,4648.54
    1692069810,4616.23
    1692069820,4629.58
    1692069830,4649.43
    1692069840,4641.22
    1692069850,4612.13
    1692069860,4611.82
    1692069870,4632.91
    1692069880,4657.82
    1692069890,4613.31
    1692069900,4646.92
    1692069910,4601.26
    1692069920,4623.44
    1692069930,4624.73
    1692069940,4592.82
    1692069950,4584.39
    1692069960,4620.55
    1692069970,4585.33
    1692069980,4576.38
    1692069990,4578.90
    1692070000,4580.18
    1692070010,4606.34
    1692070020,4597.82
    1692070030,4600.14
    1692070040,4592.57
    1692070050,4570.58
    1692070060,4594.71
    1692070070,4602.73
    1692070080,4589.08
    1692070090,4584.69
    1692070100,4558.67
    1692070110,4576.56
    1692070120,4554.23
    1692070130,4568.47
    1692070140,4534.45
    1692070150,4532.92
    1692070160,4560.06
    1692070170,4551.22
    1692070180,4562.64
    1692070190,4556.12
    1692070200,4557.73
    1692070210,4567.61
    1692070220,4544.49
    1692070230,4547.68
    1692070240,4579.48
    1692070250,4548.75
    1692070260,4543.42
    1692070270,4546.96
    1692070280,4540.40
    1692070290,4527.74
    1692070300,4520.29
    1692070310,4523.29
    1692070320,4554.33
    1692070330,4522.58
    1692070340,4530.39
    1692070350,4545.82
    1692070360,4524.55
    1692070370,4541.10
    1692070380,4495.92
    1692070390,4522.40
    1692070400,4524.94
    1692070410,4522.14
    1692070420,4486.93
    1692070430,4542.36
    1692070440,4499.52
    1692070450,4521.62
    1692070460,4513.39
    1692070470,4531.62
    1692070480,4553.61
    1692070490,4482.36
    1692070500,4493.50
    1692070510,4508.57
    1692070520,4481.00
    1692070530,4517.06
    1692070540,4516.60
    1692070550,4509.23
    1692070560,4501.08
    1692070570,4522.06
    1692070580,4469.86
    1692070590,4492.59
    1692070600,4474.82
    1692070610,4505.71
    1692070620,4449.56
    1692070630,4483.97
    1692070640,4489.55
    1692070650,4462.21
    1692070660,4466.95
    1692070670,4478.09
    1692070680,4495.19
    1692070690,4453.75
    1692070700,4455.55
    1692070710,4493.54
    1692070720,4463.88
    1692070730,4452.10
    1692070740,4480.54
    1692070750,4454.51
    1692070760,4483.14
    1692070770,4447.62
    1692070780,4456.02
    1692070790,4476.42
    1692070800,4451.31
    1692070810,4469.27
    1692070820,4451.15
    1692070830,4490.40
    1692070840,4480.46
    1692070850,4420.83
    1692070860,4456.15
    1692070870,4427.69
    1692070880,4446.16
    1692070890,4442.01
    1692070900,4417.84
    1692070910,4458.43
    1692070920,4439.64
    1692070930,4428.19
    1692070940,4423.44
    1692070950,4433.31
    1692070960,4436.98
    1692070970,4424.63
    1692070980,4368.79
    1692070990,4424.09
    1692071000,4393.24
    1692071010,4416.19
    1692071020,4390.60
    1692071030,4388.67
    1692071040,4440.02
    1692071050,4407.23
    1692071060,4404.01
    1692071070,4419.90
    1692071080,4401.15
    1692071090,4448.95
    1692071100,4399.73
    1692071110,4410.80
    1692071120,4421.23
    1692071130,4432.17
    1692071140,4383.59
    1692071150,4388.39
    1692071160,4420.55
    1692071170,4409.57
    1692071180,4413.18
    1692071190,4362.62
    1692071200,4419.26
    1692071210,4371.39
    1692071220,4388.77
    1692071230,4380.27
    1692071240,4363.98
    1692071250,4351.61
    1692071260,4343.30
    1692071270,4378.87
    1692071280,4344.29
    1692071290,4350.43
    1692071300,4367.06
    1692071310,4316.96
    1692071320,4383.62
    1692071330,4318.16
    1692071340,4363.12
    1692071350,4363.28
    1692071360,4372.05
    1692071370,4358.77
    1692071380,4398.27
    1692071390,4360.55
    1692071400,4375.61
    1692071410,4338.38
    1692071420,4353.58
    1692071430,4380.43
    1692071440,4343.03
    1692071450,4349.94
    1692071460,4364.03
    1692071470,4327.88
    1692071480,4297.80
    1692071490,4344.46
    1692071500,4357.43
    1692071510,4308.94
    1692071520,4347.68
    1692071530,4346.13
    1692071540,4285.43
    1692071550,4310.49
    1692071560,4319.61
    1692071570,4322.25
    1692071580,4309.29
    1692071590,4306.52
    1692071600,4354.20
    1692071610,4316.93
    1692071620,4303.50
    1692071630,4314.89
    1692071640,4324.76
    1692071650,4313.36
    1692071660,4306.53
    1692071670,4295.96
    1692071680,4294.02
    1692071690,4293.62
    1692071700,4310.67
    1692071710,4282.32
    1692071720,4308.38
    1692071730,4327.09
    1692071740,4303.65
    1692071750,4288.06
    1692071760,4267.80
    1692071770,4323.64
    1692071780,4266.98
    1692071790,4305.67
    1692071800,4299.78
    1692071810,4280.58
    1692071820,4278.37
    1692071830,4245.23
    1692071840,4286.86
    1692071850,4290.97
    1692071860,4255.10
    1692071870,4272.07
    1692071880,4274.26
    1692071890,4283.51
    1692071900,4270.20
    1692071910,4235.91
    1692071920,4256.15
    1692071930,4269.55
    1692071940,4280.20
    1692071950,4249.33
    1692071960,4303.75
    1692071970,4220.42
    1692071980,4245.35
    1692071990,4253.27
    1692072000,4249.23
    1692072010,4226.91
    1692072020,4258.82
    1692072030,4255.60
    1692072040,4247.45
    1692072050,4251.44
    1692072060,4234.64
    1692072070,4209.08
    1692072080,4225.40
    1692072090,4241.19
    1692072100,4239.62
    1692072110,4235.50
    1692072120,4243.96
    1692072130,4219.67
    1692072140,4230.14
    1692072150,4239.36
    1692072160,4224.53
    1692072170,4199.68
    1692072180,4203.63
    1692072190,4237.78
    1692072200,4247.33
    1692072210,4241.30
    1692072220,4220.75
    1692072230,4190.35
    1692072240,4212.60
    1692072250,4242.28
    1692072260,4221.72
    1692072270,4203.51
    1692072280,4218.54
    1692072290,4178.90
    1692072300,4188.68
    1692072310,4179.22
    1692072320,4208.61
    1692072330,4211.81
    1692072340,4192.77
    1692072350,4176.70
    1692072360,4192.07
    1692072370,4181.05
    1692072380,4173.17
    1692072390,4194.18
    1692072400,4170.55
    1692072410,4152.70
    1692072420,4155.45
    1692072430,4148.58
    1692072440,4183.91
    1692072450,4180.28
    1692072460,4177.59
    1692072470,4185.65
    1692072480,4196.05
    1692072490,4158.67
    1692072500,4176.96
    1692072510,4135.55
    1692072520,4193.03
    1692072530,4138.87
    1692072540,4147.88
    1692072550,4148.44
    1692072560,4128.18
    1692072570,4157.66
    1692072580,4159.60
    1692072590,4149.85
    1692072600,4121.14
    1692072610,4189.93
    1692072620,4159.56
    1692072630,4199.57
    1692072640,4129.09
    1692072650,4162.66
    1692072660,4157.40
    1692072670,4134.32
    1692072680,4166.66
    1692072690,4128.65
    1692072700,4127.85
    1692072710,4063.95
    1692072720,4139.87
    1692072730,4103.49
    1692072740,4117.30
    1692072750,4106.10
    1692072760,4117.61
    1692072770,4132.13
    1692072780,4121.78
    1692072790,4134.06
    1692072800,4143.50
    1692072810,4109.12
    1692072820,4105.24
    1692072830,4132.27
    1692072840,4132.17
    1692072850,4124.55
    1692072860,4089.01
    1692072870,4114.82
    1692072880,4106.87
    1692072890,4124.04
    1692072900,4089.84
    1692072910,4066.28
    1692072920,4111.73
    1692072930,4045.07
    1692072940,4079.92
    1692072950,4072.40
    1692072960,4070.57
    1692072970,4074.50
    1692072980,4112.14
    1692072990,4102.52
    1692073000,4079.38
    1692073010,4105.40
    1692073020,4059.80
    1692073030,4055.39
    1692073040,4094.94
    1692073050,4087.57
    1692073060,4065.08
    1692073070,4049.89
    1692073080,4100.11
    1692073090,4034.82
    1692073100,4055.57
    1692073110,4070.42
    1692073120,4100.20
    1692073130,4070.13
    1692073140,4070.39
    1692073150,4047.71
    1692073160,4068.78
    1692073170,4057.82
    1692073180,4022.26
    1692073190,4068.20
    1692073200,4070.06
    1692073210,4065.03
    1692073220,4047.94
    1692073230,4026.46
    1692073240,3997.72
    1692073250,4045.35
    1692073260,4062.16
    1692073270,4058.75
    1692073280,4053.47
    1692073290,4033.97
    1692073300,4055.52
    1692073310,4050.57
    1692073320,4021.94
    1692073330,4042.24
    1692073340,4016.30
    1692073350,4036.13
    1692073360,3997.66
    1692073370,3997.51
    1692073380,4041.43
    1692073390,4037.33
    1692073400,4029.56
    1692073410,4016.96
    1692073420,3965.69
    1692073430,4010.33
    1692073440,4019.22
    1692073450,3997.75
    1692073460,3992.51
    1692073470,4033.96
    1692073480,4002.18
    1692073490,4010.79
    1692073500,4015.49
    1692073510,3978.29
    1692073520,4000.49
    1692073530,4021.33
    1692073540,4029.64
    1692073550,3992.36
    1692073560,3985.12
    1692073570,3993.57
    1692073580,3991.37
    1692073590,4012.55
    1692073600,3963.20
    1692073610,3975.84
    1692073620,3957.40
    1692073630,3957.82
    1692073640,3983.90
    1692073650,3990.88
    1692073660,3960.01
    1692073670,3986.75
    1692073680,3991.85
    1692073690,4006.62
    1692073700,3967.64
    1692073710,3951.76
    1692073720,3942.81
    1692073730,3939.14
    1692073740,3984.48
    1692073750,3927.50
    1692073760,3980.47
    1692073770,3937.05
    1692073780,3939.03
    1692073790,3948.02
    1692073800,3935.29
    1692073810,3966.31
    1692073820,3982.25
    1692073830,3931.14
    1692073840,3933.96
    1692073850,3937.65
    1692073860,3950.05
    1692073870,3934.47
    1692073880,3963.60
    1692073890,3957.10
    1692073900,3908.77
    1692073910,3941.21
    1692073920,3959.51
    1692073930,3917.52
    1692073940,3919.84
    1692073950,3913.47
    1692073960,3912.20
    1692073970,3887.29
    1692073980,3892.40
    1692073990,3918.83
    1692074000,3945.87
    1692074010,3901.64
    1692074020,3899.36
    1692074030,3944.56
    1692074040,3886.67
    1692074050,3873.93
    1692074060,3888.89
    1692074070,3890.52
    1692074080,3867.14
    1692074090,3897.84
    1692074100,3917.68
    1692074110,3871.30
    1692074120,3897.09
    1692074130,3901.56
    1692074140,3890.29
    1692074150,3893.98
    1692074160,3892.53
    1692074170,3870.64
    1692074180,3915.18
    1692074190,3908.47
    1692074200,3905.63
    1692074210,3900.41
    1692074220,3846.95
    1692074230,3895.28
    1692074240,3888.19
    1692074250,3842.66
    1692074260,3867.40
    1692074270,3875.55
    1692074280,3901.61
    1692074290,3881.13
    1692074300,3847.65
    1692074310,3897.17
    1692074320,3862.44
    1692074330,3854.76
    1692074340,3851.65
    1692074350,3824.03
    1692074360,3852.62
    1692074370,3863.08
    1692074380,3843.73
    1692074390,3858.16
    1692074400,3830.78
    1692074410,3843.56
    1692074420,3851.02
    1692074430,3846.79
    1692074440,3809.20
    1692074450,3830.84
    1692074460,3871.48
    1692074470,3826.40
    1692074480,3834.87
    1692074490,3831.13
    1692074500,3862.55
    1692074510,3855.30
    1692074520,3843.95
    1692074530,3806.65
    1692074540,3831.61
    1692074550,3834.10
    1692074560,3807.08
    1692074570,3801.95
    1692074580,3851.77
    1692074590,3809.97
    1692074600,3846.60
    1692074610,3832.55
    1692074620,3819.08
    1692074630,3818.28
    1692074640,3779.54
    1692074650,3809.99
    1692074660,3832.51
    1692074670,3816.11
    1692074680,3803.88
    1692074690,3833.34
    1692074700,3793.71
    1692074710,3783.34
    1692074720,3797.12
    1692074730,3807.68
    1692074740,3756.31
    1692074750,3794.67
    1692074760,3803.49
    1692074770,3780.20
    1692074780,3806.05
    1692074790,3795.04
    1692074800,3823.36
    1692074810,3763.83
    1692074820,3793.77
    1692074830,3755.12
    1692074840,3741.47
    1692074850,3731.38
    1692074860,3781.17
    1692074870,3772.40
    1692074880,3757.45
    1692074890,3729.87
    1692074900,3749.84
    1692074910,3762.04
    1692074920,3776.14
    1692074930,3758.25
    1692074940,3761.94
    1692074950,3747.69
    1692074960,3788.51
    1692074970,3731.47
    1692074980,3736.16
    1692074990,3738.61
    1692075000,3757.62
    1692075010,3724.30
    1692075020,3746.11
    1692075030,3745.00
    1692075040,3726.13
    1692075050,3744.93
    1692075060,3716.48
    1692075070,3712.61
    1692075080,3735.25
    1692075090,3698.38
    1692075100,3686.99
    1692075110,3738.85
    1692075120,3747.49
    1692075130,3715.48
    1692075140,3709.77
    1692075150,3741.55
    1692075160,3696.85
    1692075170,3690.80
    1692075180,3730.53
    1692075190,3714.87
    1692075200,3734.30
    1692075210,3668.51
    1692075220,3681.61
    1692075230,3708.22
    1692075240,3714.60
    1692075250,3721.50
    1692075260,3706.37
    1692075270,3704.48
    1692075280,3691.71
    1692075290,3729.63
    1692075300,3674.06
    1692075310,3701.61
    1692075320,3672.99
    1692075330,3701.75
    1692075340,3668.63
    1692075350,3702.56
    1692075360,3688.23
    1692075370,3719.20
    1692075380,3676.99
    1692075390,3689.43
    1692075400,3663.64
    1692075410,3671.79
    1692075420,3677.98
    1692075430,3643.63
    1692075440,3644.13
    1692075450,3682.79
    1692075460,3666.19
    1692075470,3655.56
    1692075480,3650.99
    1692075490,3650.07
    1692075500,3664.61
    1692075510,3669.57
    1692075520,3617.14
    1692075530,3685.55
    1692075540,3682.44
    1692075550,3607.30
    1692075560,3673.94
    1692075570,3671.64
    1692075580,3648.86
    1692075590,3621.22
    1692075600,3665.78
    1692075610,3638.96
    1692075620,3653.07
    1692075630,3684.79
    1692075640,3643.76
    1692075650,3618.69
    1692075660,3628.63
    1692075670,3617.87
    1692075680,3640.64
    1692075690,3614.16
    1692075700,3619.13
    1692075710,3601.21
    1692075720,3622.57
    1692075730,3627.06
    1692075740,3568.14
    1692075750,3625.34
    1692075760,3617.55
    1692075770,3601.47
    1692075780,3655.66
    1692075790,3632.57
    1692075800,3589.78
    1692075810,3626.78
    1692075820,3633.22
    1692075830,3609.28
    1692075840,3612.18
    1692075850,3610.03
    1692075860,3559.86
    1692075870,3596.15
    1692075880,3593.42
    1692075890,3625.12
    1692075900,3601.50
    1692075910,3587.18
    1692075920,3589.65
    1692075930,3610.23
    1692075940,3584.38
    1692075950,3572.42
    1692075960,3579.18
    1692075970,3601.82
    1692075980,3591.24
    1692075990,3580.52
    1692076000,3581.77
    1692076010,3565.06
    1692076020,3570.69
    1692076030,3559.61
    1692076040,3565.29
    1692076050,3596.43
    1692076060,3546.26
    1692076070,3552.35
    1692076080,3539.35
    1692076090,3533.33
    1692076100,3557.32
    1692076110,3547.02
    1692076120,3592.92
    1692076130,3550.34
    1692076140,3580.10
    1692076150,3571.98
    1692076160,3546.75
    1692076170,3591.45
    1692076180,3552.92
    1692076190,3576.13
    1692076200,3572.11
    1692076210,3550.78
    1692076220,3555.82
    1692076230,3551.59
    1692076240,3514.54
    1692076250,3536.88
    1692076260,3555.53
    1692076270,3562.88
    1692076280,3516.26
    1692076290,3539.56
    1692076300,3530.31
    1692076310,3523.25
    1692076320,3531.04
    1692076330,3526.59
    1692076340,3531.37
    1692076350,3547.69
    1692076360,3532.85
    1692076370,3521.69
    1692076380,3551.08
    1692076390,3534.30
    1692076400,3508.56
    1692076410,3484.38
    1692076420,3487.28
    1692076430,3524.01
    1692076440,3491.05
    1692076450,3481.81
    1692076460,3485.12
    1692076470,3484.85
    1692076480,3513.92
    1692076490,3492.08
    1692076500,3466.08
    1692076510,3492.46
    1692076520,3494.60
    1692076530,3478.88
    1692076540,3509.89
    1692076550,3476.67
    1692076560,3505.57
    1692076570,3493.65
    1692076580,3498.56
    1692076590,3456.36
    1692076600,3478.61
    1692076610,3473.90
    1692076620,3444.83
    1692076630,3493.68
    1692076640,3453.55
    1692076650,3456.02
    1692076660,3446.25
    1692076670,3478.85
    1692076680,3432.62
    1692076690,3473.81
    1692076700,3480.66
    1692076710,3468.82
    1692076720,3470.64
    1692076730,3469.89
    1692076740,3434.02
    1692076750,3480.02
    1692076760,3440.43
    1692076770,3446.62
    1692076780,3439.61
    1692076790,3454.40
    1692076800,3432.12
    1692076810,3442.53
    1692076820,3414.80
    1692076830,3461.11
    1692076840,3449.54
    1692076850,3428.60
    1692076860,3423.37
    1692076870,3443.96
    1692076880,3415.23
    1692076890,3430.20
    1692076900,3449.23
    1692076910,3408.09
    1692076920,3430.00
    1692076930,3427.25
    1692076940,3417.30
    1692076950,3407.48
    1692076960,3440.17
    1692076970,3402.23
    1692076980,3376.25
    1692076990,3423.62
    1692077000,3385.09
    1692077010,3421.27
    1692077020,3432.44
    1692077030,3416.65
    1692077040,3423.79
    1692077050,3441.08
    1692077060,3418.32
    1692077070,3403.91
    1692077080,3428.29
    1692077090,3429.02
    1692077100,3427.61
    1692077110,3380.70
    1692077120,3361.78
    1692077130,3376.11
    1692077140,3399.55
    1692077150,3386.98
    1692077160,3377.98
    1692077170,3391.63
    1692077180,3349.31
    1692077190,3379.86
    1692077200,3397.72
    1692077210,3384.65
    1692077220,3385.81
    1692077230,3402.24
    1692077240,3367.28
    1692077250,3353.85
    1692077260,3389.01
    1692077270,3386.96
    1692077280,3373.01
    1692077290,3356.95
    1692077300,3358.50
    1692077310,3331.25
    1692077320,3377.35
    1692077330,3374.96
    1692077340,3325.48
    1692077350,3367.38
    1692077360,3356.42
    1692077370,3326.21
    1692077380,3320.84
    1692077390,3350.75
    1692077400,3333.63
    1692077410,3376.30
    1692077420,3357.26
    1692077430,3346.00
    1692077440,3345.30
    1692077450,3359.76
    1692077460,3348.39
    1692077470,3339.77
    1692077480,3308.48
    1692077490,3387.63
    1692077500,3302.64
    1692077510,3316.77
    1692077520,3288.23
    1692077530,3330.42
    1692077540,3320.97
    1692077550,3331.57
    1692077560,3279.79
    1692077570,3335.15
    1692077580,3295.05
    1692077590,3306.53
    1692077600,3326.45
    1692077610,3311.36
    1692077620,3311.08
    1692077630,3318.74
    1692077640,3309.65
    1692077650,3292.56
    1692077660,3294.36
    1692077670,3300.24
    1692077680,3276.41
    1692077690,3312.55
    1692077700,3296.71
    1692077710,3290.75
    1692077720,3311.41
    1692077730,3283.47
    1692077740,3280.54
    1692077750,3272.81
    1692077760,3287.67
    1692077770,3285.29
    1692077780,3264.11
    1692077790,3272.19
    1692077800,3260.87
    1692077810,3258.27
    1692077820,3236.08
    1692077830,3264.37
    1692077840,3233.26
    1692077850,3256.36
    1692077860,3251.67
    1692077870,3283.28
    1692077880,3240.25
    1692077890,3243.64
    1692077900,3249.54
    1692077910,3243.88
    1692077920,3281.18
    1692077930,3229.34
    1692077940,3242.83
    1692077950,3255.37
    1692077960,3264.67
    1692077970,3237.75
    1692077980,3205.31
    1692077990,3238.98
    1692078000,3267.33
    1692078010,3244.25
    1692078020,3241.64
    1692078030,3213.97
    1692078040,3210.23
    1692078050,3232.21
    1692078060,3201.64
    1692078070,3244.10
    1692078080,3209.85
    1692078090,3224.60
    1692078100,3185.69
    1692078110,3213.85
    1692078120,3196.32
    1692078130,3171.91
    1692078140,3227.49
    1692078150,3247.79
    1692078160,3235.87
    1692078170,3225.23
    1692078180,3201.62
    1692078190,3224.33
    1692078200,3231.00
    1692078210,3207.58
    1692078220,3179.46
    1692078230,3191.47
    1692078240,3233.83
    1692078250,3196.59
    1692078260,3129.90
    1692078270,3165.33
    1692078280,3184.53
    1692078290,3212.05
    1692078300,3184.18
    1692078310,3209.05
    1692078320,3175.75
    1692078330,3145.29
    1692078340,3173.06
    1692078350,3188.10
    1692078360,3184.75
    1692078370,3152.72
    1692078380,3169.11
    1692078390,3228.14
    1692078400,3148.10
    1692078410,3184.29
    1692078420,3127.45
    1692078430,3184.97
    1692078440,3148.16
    1692078450,3172.36
    1692078460,3136.80
    1692078470,3166.76
    1692078480,3141.08
    1692078490,3143.27
    1692078500,3164.72
    1692078510,3145.58
    1692078520,3160.11
    1692078530,3147.00
    1692078540,3150.48
    1692078550,3156.34
    1692078560,3138.75
    1692078570,3124.14
    1692078580,3131.73
    1692078590,3164.59
    1692078600,3141.32
    1692078610,3120.41
    1692078620,3143.65
    1692078630,3143.30
    1692078640,3142.64
    1692078650,3111.00
    1692078660,3115.22
    1692078670,3113.64
    1692078680,3118.28
    1692078690,3134.58
    1692078700,3128.04
    1692078710,3127.93
    1692078720,3145.82
    1692078730,3130.83
    1692078740,3112.53
    1692078750,3090.00
    1692078760,3097.69
    1692078770,3105.06
    1692078780,3125.19
    1692078790,3106.37
    1692078800,3092.11
    1692078810,3088.89
    1692078820,3100.46
    1692078830,3117.97
    1692078840,3130.30
    1692078850,3092.68
    1692078860,3094.21
    1692078870,3069.14
    1692078880,3130.51
    1692078890,3062.02
    1692078900,3111.78
    1692078910,3079.35
    1692078920,3072.99
    1692078930,3061.08
    1692078940,3129.80
    1692078950,3084.34
    1692078960,3078.65
    1692078970,3094.27
    1692078980,3061.83
    1692078990,3073.19
    1692079000,3072.59
    1692079010,3059.54
    1692079020,3092.08
    1692079030,3062.03
    1692079040,3033.65
    1692079050,3057.00
    1692079060,3066.32
    1692079070,3041.78
    1692079080,3041.67
    1692079090,3045.35
    1692079100,3079.01
    1692079110,3043.15
    1692079120,3079.79
    1692079130,3037.22
    1692079140,3054.33
    1692079150,3037.22
    1692079160,3059.54
    1692079170,3020.40
    1692079180,3055.94
    """
    logs_data = """
    2023-08-15 10:32:15,423 ERROR [RiskManagement-DecisionService] Decision latency threshold exceeded - {transaction_id=TXID_89123, current_latency=812ms, dependency_latencies=[features=420ms, rules=380ms]}
    2023-08-15 11:17:34,112 ERROR [ExternalDataSource@10.20.30.40] Third-party feature service timeout - {endpoint=/risk/feature/v3, response_code=504, duration=632ms, retries=3}
    2023-08-15 12:45:01,789 ERROR [ThreadPool-Manager] Execution queue saturation - {pool_name=DecisionExecutor, queue_size=587, active_threads=50, max_pool_size=50}
    2023-08-15 10:18:55,002 WARN  [RuleEngine-Core@BigDataPlatform] Rule execution delay detected - {rule_set=FRAUD_RULE_SET_V5, avg_exec_time=85ms, plan_generation=120ms}
    2023-08-15 11:05:12,334 WARN  [RiskManagement-Orchestrator] Thread pool exhaustion risk - {available_workers=2, pending_tasks=234, avg_wait_time=450ms}
    2023-08-15 12:30:45,671 WARN  [ExternalDataSource@10.20.30.40] Connection pool utilization critical - {pool_type=Oracle, utilization=95%, waiters=15}
    2023-08-15 10:25:33,901 INFO  [RiskFeatureService] State transition: FEATURE_CALC_DEGRADED - {reason=upstream_timeout, affected_rules=[RULE_887, RULE_902]}
    2023-08-15 11:45:22,156 INFO  [SystemHealth] Throughput degradation alert - {current_tps=3850, health_score=58, degraded_components=[RuleEngine, FeatureService]}
    2023-08-15 13:15:09,887 INFO  [FallbackManager] Circuit breaker triggered - {service=ExternalFraudAPI, state=OPEN, failure_rate=68%}
    2023-08-15 10:47:12,556 DEBUG [DataSerializer@BigDataPlatform] Feature serialization metrics - {payload_size=38KB, serde_time=45ms, compression_ratio=65%}
    2023-08-15 11:32:44,231 DEBUG [QueryOptimizer] Slow SQL execution plan - {
      "query_hash": "A3F89B2C", 
      "duration": 3200ms, 
      "explain_plan": "FULL TABLE SCAN ON RISK_FEATURES", 
      "lock_wait": 450ms
    }
    2023-08-15 12:10:33,765 DEBUG [JIT-Compiler@RiskManagement] Hot method recompilation - {
      "method": "com.risk.engine.RuleEvaluator.evaluate()", 
      "compile_count": 15, 
      "deopt_count": 3, 
      "code_cache": 89%
    }
    2023-08-15 13:58:12,445 INFO  [ThreadPool-Manager] Queue drainage completed - {pool_name=DecisionExecutor, drained_tasks=1234, recovery_time=2800ms}
    2023-08-15 14:02:33,112 INFO  [SystemHealth] Throughput recovered - {current_tps=5450, health_score=85}
    """
    events_data = {
      "timeline": [
        {
          "timestamp": "2023-08-15T10:25:33+08:00",
          "event_type": "system_state_transition",
          "details": {
            "service": "RiskFeatureService",
            "previous_state": "NORMAL",
            "new_state": "FEATURE_CALC_DEGRADED",
            "reason": "upstream_timeout"
          }
        },
        {
          "timestamp": "2023-08-15T11:45:22+08:00",
          "event_type": "service_health_change",
          "details": {
            "alert_type": "Throughput degradation",
            "component": "SystemHealth",
            "health_score": 58,
            "degraded_components": ["RuleEngine", "FeatureService"]
          }
        },
        {
          "timestamp": "2023-08-15T13:15:09+08:00",
          "event_type": "system_state_transition",
          "details": {
            "service": "FallbackManager",
            "previous_state": "CLOSED",
            "new_state": "OPEN",
            "reason": "ExternalFraudAPI failure_rate=68%"
          }
        },
        {
          "timestamp": "2023-08-15T14:02:33+08:00",
          "event_type": "service_health_change",
          "details": {
            "alert_type": "Throughput recovery",
            "component": "SystemHealth",
            "health_score": 85,
            "recovery_evidence": "TPS restored to 5450 transactions/second"
          }
        }
      ],
      "auto_scaling_events": []
    }

    root_cause_analysis = get_root_cause_analysis(enriched_incident, metrics_data, logs_data, events_data)
    print(root_cause_analysis)
